# Развертывание Oracle Database с помощью GitHub Actions

Этот workflow GitHub Actions автоматизирует развертывание базы данных Oracle с использованием Docker и Docker Compose. Он подключается к удаленному серверу по SSH, устанавливает Docker и Docker Compose (если необходимо), загружает образ базы данных Oracle, настраивает базу данных с использованием переменных среды и запускает контейнер базы данных. Он также копирует схему `human_resources` из репозитория примеров схем Oracle в контейнер.

## Предварительные требования

Перед использованием этого workflow убедитесь, что у вас есть следующее:

*   **Удаленный сервер с доступом по SSH:** Этот сервер должен быть способен запускать Docker и Docker Compose. Рекомендуется Ubuntu, но могут работать и другие дистрибутивы Linux.
*   **Docker и Docker Compose, установленные на удаленном сервере (или workflow попытается их установить):** Этот workflow автоматизирует установку, если они отсутствуют.
*   **Репозиторий GitHub с этим файлом workflow:** Файл workflow должен быть помещен в каталог `.github/workflows` вашего репозитория.
*   **Необходимые секреты, настроенные в вашем репозитории GitHub:** См. раздел "Секреты" ниже.
*   **Достаточно места на диске удаленного сервера:** Для образа и данных базы данных Oracle требуется значительное количество места на диске.
*   **Публичный IP-адрес на вашем удаленном сервере (или настроена переадресация портов):** Чтобы получить доступ к базе данных извне сервера, вам необходимо либо иметь публичный IP-адрес, либо настроить переадресацию портов.

## Секреты

Этот workflow использует следующие секреты, которые необходимо настроить в настройках вашего репозитория GitHub (Settings -> Security -> Secrets and variables -> Actions):

*   **`SSH_PRIVATE_KEY`:** Приватный ключ, используемый для SSH-аутентификации на удаленном сервере. **Важно:** Этот ключ должен быть без пароля. Сгенерируйте ключ специально для этой цели.
*   **`SSH_HOST`:** Имя хоста или IP-адрес удаленного сервера.
*   **`SSH_USER`:** Имя пользователя для доступа по SSH к удаленному серверу.
*   **`ORACLE_PWD`:** Пароль для пользователей Oracle database `SYS`, `SYSTEM` и `PDBADMIN`. Этот пароль должен соответствовать требованиям Oracle к сложности паролей. Он должен содержать от 8 до 30 символов и должен содержать как минимум 1 символ верхнего регистра, 1 символ нижнего регистра и 1 цифру.

**Важное замечание о безопасности:** Храните свой приватный ключ SSH и пароль базы данных в виде секретов в GitHub. Никогда не фиксируйте их непосредственно в свой репозиторий!

## Подробности о Workflow

Workflow состоит из следующих задач и шагов:

1.  **Задача `deploy`:** Эта задача выполняется на runner `ubuntu-latest`.

2.  **Шаг `Checkout code`:** Извлекает код из вашего репозитория.

    *   `uses: actions/checkout@v4`

3.  **Шаг `Set up SSH`:** Настраивает SSH-агент с помощью действия `webfactory/ssh-agent` и предоставляет секрет `SSH_PRIVATE_KEY`.

    *   `uses: webfactory/ssh-agent@v0.7.0`
    *   `with:`
        *   `ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}`

4.  **Шаг `Get SSH host key`:** Добавляет ключ хоста удаленного сервера в файл `known_hosts`, чтобы предотвратить предупреждения о подключении по SSH.

    *   `run:`
        *   `mkdir -p ~/.ssh`
        *   `ssh-keyscan ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts`

5.  **Шаг `Prepare OS`:** Подключается к удаленному серверу по SSH и выполняет следующие действия:

    *   Устанавливает Docker и Docker Compose, если они еще не установлены.
    *   Клонирует репозиторий примеров схем Oracle.
    *   `run:`
        *   `ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'`

6.  **Шаг `Prepare container`:** Подключается к удаленному серверу по SSH и выполняет следующие действия:

    *   Загружает образ базы данных Oracle из реестра контейнеров Oracle.
    *   Создает том Docker для данных базы данных.
    *   Создает файл `docker-compose.yml` для определения контейнера базы данных.
    *   Создает файл `.env` для хранения переменных среды (включая `ORACLE_PWD`).
    *   `run:`
        *   `ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOC'`

7.  **Шаг `Install Oracle`:** Подключается к удаленному серверу по SSH и выполняет следующие действия:

    *   Запускает контейнер базы данных с помощью Docker Compose.
    *   Ждет, пока база данных будет готова.
    *   Копирует схему `human_resources` из клонированного репозитория в контейнер.
    *   `run:`
        *   `ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOD'`

## Загрузка схемы `human_resources`

Workflow копирует определение схемы `human_resources` в каталог `/tmp/human_resources` внутри контейнера `oracle_database`. Чтобы загрузить эту схему, выполните следующие действия *после* успешного завершения workflow:

1.  **Подключитесь к базе данных как `sysdba`:**

    ```bash
    sudo docker exec -it oracle_database sqlplus "sys/${{ secrets.ORACLE_PWD }}@//localhost:1521/FREEPDB1 as sysdba"
    ```

    *Замените `${{ secrets.ORACLE_PWD }}` на фактический пароль, который вы выбрали, или обратитесь к переменной среды, если вы запускаете это внутри скрипта.*

2.  **Запустите скрипт `hr_install.sql`:**

    ```sql
    @/tmp/human_resources/hr_install.sql
    ```

3.  **Скрипт запросит пароли для пользователей `hr` и `OE`. Предоставьте пароль для каждого пользователя и нажмите Enter.** Если вы хотите оставить их пустыми, просто нажмите Enter в каждом запросе.

4.  **Подключитесь к базе данных как `hr`:**

    ```bash
    docker exec -it oracle_database sqlplus "hr/${{ secrets.ORACLE_PWD }}@//localhost:1521/FREEPDB1"
    ```

    *Замените `${{ secrets.ORACLE_PWD }}` на пароль, который вы ввели, когда вас запросили пароль пользователя `hr`. Если вы оставили пароль пустым, возможно, вам потребуется создать пароль для пользователя `hr` внутри самой базы данных.*

## Устранение неполадок

*   **Проблемы с SSH-подключением:** Убедитесь, что ваши `SSH_PRIVATE_KEY`, `SSH_HOST` и `SSH_USER` настроены правильно в секретах репозитория. Убедитесь, что ключ SSH не защищен паролем.
*   **Ошибки установки Docker:** Проверьте логи на наличие ошибок во время установки Docker. Убедитесь, что у пользователя есть права sudo.
*   **Проблемы с запуском базы данных:** Проверьте логи контейнера Docker на наличие ошибок. Вы можете получить доступ к логам с помощью `docker logs <container_name>`. Убедитесь, что пароль, используемый для `ORACLE_PWD`, соответствует требованиям Oracle к сложности паролей.
*   **Недостаточно места на диске:** Убедитесь, что на удаленном сервере достаточно места на диске для образа и данных базы данных Oracle. Сам образ имеет размер несколько гигабайт, а объем данных может значительно увеличиться.
*   **Доступность порта:** Убедитесь, что порт 1521 доступен с вашей клиентской машины. Возможно, вам потребуется настроить правила брандмауэра на удаленном сервере.
*   **Сбои Workflow:** Изучите логи workflow в GitHub Actions, чтобы определить конкретный шаг, который не удался, и любые связанные с ним сообщения об ошибках.
*   **Ошибки Docker Compose:** Проверьте вывод `docker-compose --verbose up -d` в логах workflow на наличие проблем с конфигурацией Docker Compose.

## Действия после развертывания

После успешного завершения workflow вы можете подключиться к базе данных Oracle с помощью клиента базы данных, такого как SQL Developer или SQL*Plus. Используйте следующие данные для подключения:
sudo docker exec -it oracle_database sqlplus "sys/mysecurepassword@//localhost:1521/FREEPDB1 as sysdba"
*   **Имя хоста:** `SSH_HOST` (или публичный IP-адрес сервера)
*   **Порт:** 1521
*   **Имя сервиса:** `FREEPDB1`
*   **Имя пользователя:** `SYSTEM`, `SYS` или `PDBADMIN`
*   **Пароль:** Значение, которое вы установили для секрета `ORACLE_PWD`.

Вы также можете запустить скрипты в папке human_resources, чтобы загрузить схему в контейнер.
